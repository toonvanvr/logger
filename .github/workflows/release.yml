name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.0.0-alpha.1)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  test-ts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: cd packages/shared && bun test
      - run: cd packages/client && bun test
      - run: cd packages/server && bun test
      - run: cd packages/mcp && bun test

  test-flutter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: cd app && flutter pub get
      - run: cd app && flutter analyze
      - run: cd app && flutter test

  build-linux:
    needs: [test-ts, test-flutter]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Install Linux dependencies
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev libayatana-appindicator3-dev libdbusmenu-gtk3-dev
      - name: Build
        run: |
          cd app
          flutter build linux --release \
            --dart-define=APP_VERSION=${{ inputs.version }} \
            --dart-define=COMMIT_SHA=${{ github.sha }}
      - name: Package
        run: |
          cd app/build/linux/x64/release/bundle
          tar -czf ${{ github.workspace }}/logger-linux-x64-${{ inputs.version }}.tar.gz .
      - uses: actions/upload-artifact@v4
        with:
          name: logger-linux-x64
          path: logger-linux-x64-*.tar.gz

  build-macos:
    needs: [test-ts, test-flutter]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - name: Build
        run: |
          cd app
          flutter build macos --release \
            --dart-define=APP_VERSION=${{ inputs.version }} \
            --dart-define=COMMIT_SHA=${{ github.sha }}
      - name: Package
        run: |
          cd app/build/macos/Build/Products/Release
          APP=$(ls -d *.app | head -1)
          zip -r ${{ github.workspace }}/logger-macos-arm64-${{ inputs.version }}.zip "$APP"
      - uses: actions/upload-artifact@v4
        with:
          name: logger-macos-arm64
          path: logger-macos-arm64-*.zip

  create-release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Preflight tag availability
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ inputs.version }}"
          if gh release view "$TAG" >/dev/null 2>&1 || git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Use a new version."
            exit 1
          fi
      - uses: actions/download-artifact@v4
        with:
          name: logger-linux-x64
      - uses: actions/download-artifact@v4
        with:
          name: logger-macos-arm64
      - name: Verify release artifacts
        run: |
          shopt -s nullglob
          linux=(logger-linux-x64-*.tar.gz)
          macos=(logger-macos-arm64-*.zip)
          if [ ${#linux[@]} -eq 0 ]; then
            echo "Missing Linux artifact: logger-linux-x64-*.tar.gz"
            exit 1
          fi
          if [ ${#macos[@]} -eq 0 ]; then
            echo "Missing macOS artifact: logger-macos-arm64-*.zip"
            exit 1
          fi
      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --prerelease \
            --title "v${{ inputs.version }}" \
            --notes "Release v${{ inputs.version }}\nCommit: ${{ github.sha }}" \
            logger-linux-x64-*.tar.gz \
            logger-macos-arm64-*.zip
