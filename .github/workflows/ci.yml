name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-ts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: cd packages/shared && bun test
      - run: cd packages/client && bun test
      - run: cd packages/server && bun test
      - run: cd packages/mcp && bun test

  test-flutter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
      - run: cd app && flutter pub get
      - run: cd app && flutter analyze
      - run: cd app && flutter test

  type-check-ts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: cd packages/shared && bunx tsc --noEmit
      - run: cd packages/client && bun install && bunx tsc --noEmit
      - run: cd packages/server && bun install && bunx tsc --noEmit
      - run: cd packages/mcp && bun install && bunx tsc --noEmit

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Audit server dependencies
        run: cd packages/server && bun install && bun pm ls --all
        continue-on-error: true
      - name: Audit client dependencies
        run: cd packages/client && bun install && bun pm ls --all
        continue-on-error: true
